import streamlit as st
import time
import pandas as pd
import os
import requests
import datetime
from google.generativeai import types as genai_types
import google.generativeai as genai

# باید اولین دستور بعد از import streamlit باشد!
st.set_page_config(
    page_title="آزمون تفکر انتقادی - بخش 1",
    layout="wide"
)

# --- مقداردهی اولیه متغیرهای مربوط به تایمر در session_state ---
if "exam_start_time" not in st.session_state:
    st.session_state.exam_start_time = None
if "timer_running" not in st.session_state:
    st.session_state.timer_running = False
if "time_left" not in st.session_state:
    st.session_state.time_left = 60 * 60  # 60 دقیقه بر حسب ثانیه (3600)

# --- نمایش دکمه شروع آزمون در ستون سمت راست ---
col1, col2, col3 = st.columns([2, 0.5, 8])
with col3:
    if not st.session_state.timer_running:
        if st.button("شروع آزمون", key="start_exam_button"):
            st.session_state.exam_start_time = time.time()
            st.session_state.timer_running = True
            st.session_state.time_left = 60 * 60
            st.experimental_rerun()
        st.info("برای شروع آزمون دکمه 'شروع آزمون' را بزنید.")
    else:
        # نمایش تایمر و ادامه آزمون در این بخش
        pass

if not st.session_state.timer_running:
    st.stop()

# --- پیام راهنما در صورت عدم شروع آزمون ---
if not st.session_state.timer_running:
    st.info("برای شروع آزمون دکمه 'شروع آزمون' را بزنید.")
    st.stop()

PDFSHIFT_API_KEY = "sk_314d5016e37848b36847307c7135d14f6909173d"


# ---------- تنظیم پراکسی در صورت نیاز ----------
PROXY_URL = os.getenv("APP_HTTP_PROXY", "http://172.16.217.234:33525")
if PROXY_URL:
    os.environ['HTTP_PROXY'] = PROXY_URL
    os.environ['HTTPS_PROXY'] = PROXY_URL

# ---------- کلید Gemini ----------
GEMINI_API_KEY = "AIzaSyBEZ9d7p008FjBDcw_bLWL-328AX7rAng0"

if not st.session_state.timer_running:
    if st.button("شروع آزمون"):
        st.session_state.exam_start_time = time.time()
        st.session_state.timer_running = True
        st.session_state.time_left = 60 * 60  # 60 دقیقه
        st.experimental_rerun()
elif st.session_state.timer_running and st.session_state.exam_start_time is not None:
    elapsed = int(time.time() - st.session_state.exam_start_time)
    st.session_state.time_left = max(0, 60 * 60 - elapsed)

if st.session_state.timer_running and st.session_state.exam_start_time is not None:
    minutes, seconds = divmod(st.session_state.time_left, 60)
    st.markdown(
        f"""
        <div style="background:#ffd54f;padding:10px 24px;border-radius:16px;text-align:center;font-size:1.35rem;direction:rtl;">
            ⏳ زمان باقی‌مانده: <b>{minutes:02d}:{seconds:02d}</b>
        </div>
        """,
        unsafe_allow_html=True
    )
    if st.session_state.time_left == 0:
        st.warning("⏰ زمان شما به پایان رسید! آزمون به طور خودکار بسته شد.")
        st.session_state.timer_running = False
        # می‌توانی به صورت خودکار به صفحه نتیجه هدایت کنی یا st.stop()
        st.stop()
else:
    st.info("برای شروع آزمون دکمه 'شروع آزمون' را بزنید.")
    st.stop()


st.markdown("""
    <style>
    /* استایل کامل بالا را اینجا قرار بده */
    </style>
""", unsafe_allow_html=True)

section1 = {
    "section_id": 1,
    "section_title": "شرح حال (درک مطلب و تحلیل گزاره‌ها)",
    "instruction": """راهنما:
استنباط نتیجه‌ای است که فرد می‌تواند بنا بر مشاهده یا فرض حقایقی خاص در ذهن ترسیم نماید. به‌عنوان‌مثال اگر چراغ‌های یک خانه روشن باشند و از داخل خانه صدای موسیقی شنیده شود فرد ممکن است چنین استنباط نماید که کسی در داخل خانه هست؛ اما این استنباط ممکن است درست و یا نادرست باشد شاید اهل خانه هنگام خروج از منزل چراغ‌ها و رادیو را خاموش نکرده باشند این بخش از آزمون شامل ۳ شرح‌حال با بیان یک عبارت شروع می‌شود که و نادرستی آن تصمیم‌گیری کنید.
برای هر استنباط مطرح شما باید آن را درست تلقی نمایید. بعد از هر عبارت، چند استنباط احتمالی که ممکن است توسط سایر افراد نتیجه‌گیری شده باشد آمده است. حال شما هر استنباط را به‌صورت جداگانه بررسی نمایید؛ و در مورد درجه درستی شده در برگه پاسخنامه جاهای خالی اختصاص یافته که با حروف نام‌گذاری شده و جزئیات مربوط به آن در برگه پاسخنامه توضیح داده شده است.
توجه داشته باشید گاهی اوقات جهت تصمیم‌گیری در مورد اینکه استنباط احتمالاً صحیح یا احتمالاً غلط می‌باشد. شما ناچار خواهید بود از آگاهی‌ها و اطلاعات عمومی خود استفاده کنید. ضمناً در این بخش هر شرح‌حال ارائه شده ممکن است بیش از یک استنباط صحیح، غلط، احتمالاً صحیح، احتمالاً غلط و یا داده‌های ناکافی داشته باشد؛ بنابراین باید در مورد هر استنباط به‌طور جداگانه قضاوت نمایید.""",
    "scenarios": [
        {
            "scenario_id": 1,
            "scenario": """در سال ۱۹۴۶ مانوری به نام »عملیات برفی« به انجام رسید تا محققان دریابند کدام گروه از افراد ارتش تحت شرایط آب وهوای بسیار سرد بهتر عمل میکنند. برخی عوامل مورد بررسی عبارت‌اند از: وزن، فشارخون و شرایط محیط زادگاه بود. به تمام شرکت‌کنندگان، در »عملیات برفی« قبلاً دوره آموزشی درباره زنده ماندن و کارکردن در سرمای شدید ارائه شده بود. در خاتمه مانور چنین نتیجه گرفته شد که در میان عوامل مورد مطالعه، عوامل متمایزکننده بین افرادی که عملکردشان موفقیت‌آمیز بوده از آنها که ناموفق بودند شامل موارد زیر بود:
۱) اشتیاق شرکت در مانور
۲) میزان آگاهی و مهارت در ارتباط با نحوه زندگی و حفظ حیات خود در شرایط آب و هوای سرد.""",
            "questions": [
                {
                    "id": 1,
                    "question": "برخی از شرکت کنندگان، علیرغم دوره آموزشی که برای همه شرکت‌کنندگان ارائه شده بود، از دانش و مهارت بیشتری برخوردار بودند.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "درست"
                },
                {
                    "id": 2,
                    "question": "نیروهای مسلح چنین عقیده داشتند که ممکن است روزی عملیات نظامی در محیطی با آب و هوای بسیار سرد انجام شود.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "احتمالاً درست"
                },
                {
                    "id": 3,
                    "question": "اکثریت افراد شرکت‌کننده در عملیات برفی از این مانور خوششان می‌آمد.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "داده ها کافی نیست"
                },
                {
                    "id": 4,
                    "question": "گروهی از افراد که اصلیت اسکاندیناوی داشتند در شرایط سرد بسیار موفق‌تر از کسانی که اصلیت جنوبی داشتند عمل کردند.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "غلط"
                },
                {
                    "id": 5,
                    "question": "شرکت‌کنندگانی که وزن و فشارخون بیشتری داشتند نسبت به سایر افراد موفق‌تر بودند.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "غلط"
                }
            ]
        },
        {
            "scenario_id": 2,
            "scenario": "آقای سلیمی که در فرح‌آباد تهران زندگی می‌کند، برای ششمین بار طی ماه گذشته به علت شکایت شهرداری به جرم اینکه خانه و دکه فروش تنقلات خود را تا بعد از ساعت ۱ بامداد باز نگه داشته است به دادگستری احضار شد. او باز هم به جرم خود اعتراف کرد و مطابق دفعات قبل به حداکثر جریمه یعنی پرداخت ۲۰٬۰۰۰ تومان محکوم شد.",
            "questions": [
                {
                    "id": 6,
                    "question": "برخی شب‌ها به نفع آقای سلیمی بود که حتی با وجود خطر پرداخت جریمه، خانه و دکه فروش تنقلات خود را تا بعد از ساعت ۱ بامداد باز نگه دارد.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "احتمالاً درست"
                },
                {
                    "id": 7,
                    "question": "خانه و دکه فروش آقای سلیمی تحت نظارت شهرداری در محدوده قانونی دادگستری منطقه تهران اداره می‌شود.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "درست"
                },
                {
                    "id": 8,
                    "question": "آقای سلیمی به امید امکان فرار از قانون بارها تعطیلی در ساعت ۱ بامداد را زیر پا گذاشته بود.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "داده ها کافی نیست"
                },
                {
                    "id": 9,
                    "question": "حداکثر جریمه ۲۰ هزار تومانی برای بسته نگه داشتن تمامی قهوه‌خانه‌ها و دکه فروش تنقلات شهر تهران و نواحی مجاور آن بعد از ساعت ۱ بامداد کاملاً مؤثر بود.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "غلط"
                },
                {
                    "id": 10,
                    "question": "برای یک هفته طی ماه گذشته آقای سلیمی ساعت تعطیلی قانونی را هر شب رعایت کرد.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "داده ها کافی نیست"
                }
            ]
        },
        {
            "scenario_id": 3,
            "scenario": "چندی قبل در یکی از شهرهای کشورمان جمعیتی گرد آمدند تا سخنان رئیس جدید اتاق بازرگانی را بشنوند. رئیس گفت: به من درخواست زیادی از شما ندارم فقط تقاضا می‌کنم که تجار به اتاق بازرگانی بپیوندند تا بتوانیم نقش خود را در رشد صادرات ایفا کنیم. تجار حاضر پس از شنیدن سخنان ریاست اتاق بازرگانی به ابراز احساسات پرداختند و در عرض ۳ ماه همگی به عضویت اتاق بازرگانی درآمدند. نمایندگان گمرک نظراتشان را ابراز کردند و فعالانه در طرح‌های افزایش صادرات غیرنفتی شرکت کردند. تجار و نمایندگان دولت از طریق ملاقات و تماس‌هایی که در اتاق بازرگانی داشتند از عقاید و نظرات یکدیگر بهتر مطلع شدند.",
            "questions": [
                {
                    "id": 11,
                    "question": "تجار و نمایندگان دولت از طریق ملاقات و تماس‌هایی که در اتاق بازرگانی داشتند از عقاید و نظرات یکدیگر بهتر مطلع شدند.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "احتمالاً درست"
                },
                {
                    "id": 12,
                    "question": "مشارکت تجار در اتاق بازرگانی جدال‌ها و بحث و مسئولین گمرکات را به طور چشمگیری کاهش داد.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "داده ها کافی نیست"
                },
                {
                    "id": 13,
                    "question": "مشارکت فعال تجار در تمام جلسات اتاق بازرگانی بسیاری از مخالفت‌ها را حل نمود.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "داده ها کافی نیست"
                },
                {
                    "id": 14,
                    "question": "بیشتر تاجران از اینکه دعوت به مشارکت در اتاق بازرگانی را پذیرفته بودند، پشیمان بودند.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "احتمالاً غلط"
                },
                {
                    "id": 15,
                    "question": "برخی اعضای اتاق بازرگانی احساس می‌کردند که درخواست رئیس آن برای پیوستن به اتاق بازرگانی غیر عاقلانه بوده است.",
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"],
                    "answer": "داده ها کافی نیست"
                },
                {        
                    "id": 16, 
                    "question": "رئیس جدید در سخنان خود خاطرنشان ساخت که تجار شهر هنوز کاملاً نقش خود را در امر بهبود صادرات ایفا ننمودند.", 
                    "choices": ["درست", "احتمالاً درست", "غلط", "داده ها کافی نیست"], 
                    "answer": "درست" 
                },
            ]
        }
    ]
}
section2 = {
    "section_id": 2,
    "section_title": "پیش‌فرض‌ها (شناخت فرض‌های پنهان)",
    "instruction": """منظور از پیش‌فرض آن است که موضوعی از قبل اثبات شده و با اینکه تخمینی زده می‌شود برای مثال وقتی می‌گویید من در مردادماه فارغ‌التحصیل خواهم شد مسلم پنداشته‌اید و یا فرض را بر این دانسته‌اید که تا مردادماه زنده خواهید بود و یا دانشکده‌تان شما را واجد شرایط فارغ‌التحصیلی در مردادماه خواهد دانست و چیزهایی از این قبیل: 
این بخش شامل ۵ عبارت است که به دنبال هر یک پیش‌فرض‌های پیشنهادی آورده شده است. شما باید در هر بخش فرض مشخص کنید که آیا در عبارت ذکر شده واقعاً چنان پیش‌فرضی وجود دارد؟ به‌عبارت‌دیگر تضمین با دلیل قانع‌کننده‌ای برای پذیرفته شدن آن دارد یا خیر. اگر فکر می‌کنید پیش‌فرض مطرح شده در عبارت تضمین شده است خانه مربوطه به «پیش‌فرض وجود دارد» را علامت‌گذاری کنید و اگر پیش‌فرض لزوماً در عبارت ذکر شده تضمین نشده خانه مربوط به «پیش‌فرض وجود ندارد» را علامت‌گذاری کنید. به خاطر داشته باشید هر پیش‌فرض را به‌طور جداگانه مورد بررسی قرار دهید.""",
    "scenarios": [
        {
            "scenario_id": 1,
            "scenario": "عبارت (الف):\nدر درازمدت راه‌های بیشتری برای استفاده از انرژی اتمی کشف خواهد شد که این امر باعث رستگاری بشریت می‌گردد.",
            "questions": [
                {
                    "id": 17,
                    "question": "راه‌های مختلف و مفید دیگری برای استفاده از انرژی اتمی کشف خواهد شد.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود دارد"
                },
                {
                    "id": 18,
                    "question": "کشف راه‌های جدید استفاده از انرژی اتمی نیازمند سرمایه‌گذاری اقتصادی درازمدت است.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود ندارد"
                },
                {
                    "id": 19,
                    "question": "استفاده از انرژی اتمی خطرات محیطی دارد.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود ندارد"
                }
            ]
        },
        {
            "scenario_id": 2,
            "scenario": "عبارت (ب):\nبندر انزلی شهری است که به مکان می‌توانیم آن را برای زندگی انتخاب کنیم. این شهر دارای پایین‌ترین حد تورم نسبت به سایر شهرهای کشور است.",
            "questions": [
                {
                    "id": 20,
                    "question": "تورم پایین دال بر مدیریت مؤثر شهر است.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود ندارد"
                },
                {
                    "id": 21,
                    "question": "برای تصمیم‌گیری در مورد انتخاب محل زندگی توجه به تورم مهم است.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود دارد"
                },
                {
                    "id": 22,
                    "question": "اکثریت شهروندان بندر انزلی از مسئولین فعلی شهر، راضی هستند.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود ندارد"
                }
            ]
        },
        {
            "scenario_id": 3,
            "scenario": "عبارت (ج):\nما خودمان را به جای روندهای طبیعی به دست ماشین‌ها سپرده‌ایم. ما خود را درگیر زندگی غیرطبیعی و پرفشار و خطرناک کرده‌ایم.",
            "questions": [
                {
                    "id": 23,
                    "question": "ما می‌توانیم در مقابل سوق یافتن به سوی زندگی غیرطبیعی و پرتنش مقاومت کنیم.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود دارد"
                },
                {
                    "id": 24,
                    "question": "روش زندگی که ما اتخاذ کرده‌ایم با خواسته بشر سازگار نیست.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود دارد"
                },
                {
                    "id": 25,
                    "question": "شتاب زندگی ما در رسیدن اهداف زندگی کمک نمی‌کند.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود ندارد"
                }
            ]
        },
        {
            "scenario_id": 4,
            "scenario": "عبارت (د):\nمن قصد دارم به منطقه‌ای از کشور که در آنجا حصبه شایع است سفر کنم و می‌خواهم مطمئن باشم که به حصبه مبتلا نمی‌شوم. به همین دلیل باید قبل از عزیمت جهت واکسیناسیون علیه حصبه نزد پزشک معالجم بروم.",
            "questions": [
                {
                    "id": 26,
                    "question": "اگر من واکسینه نشوم بیمار خواهم شد.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود ندارد"
                },
                {
                    "id": 27,
                    "question": "با وسیله واکسینه شدن علیه حصبه احتمال ابتلا خود را کاهش می‌دهم.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود دارد"
                },
                {
                    "id": 28,
                    "question": "حصبه در منطقه از کشور نسبت به محل زندگی من شایع‌تر است.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود دارد"
                },
                {
                    "id": 29,
                    "question": "پزشک می‌تواند با واکسینه کردن مرا در مدتی که در آن منطقه بسر می‌برم از ابتلا به حصبه، مصون بدارد.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود دارد"
                }
            ]
        },
        {
            "scenario_id": 5,
            "scenario": "عبارت (هـ):\nاکنون که برتری داریم یک جنگ پیشگیرانه را شروع کنیم اگر جنگ اجتناب‌ناپذیر است بهتر است هم‌اکنون دست به یک جنگ پیشگیرانه بزنیم.",
            "questions": [
                {
                    "id": 30,
                    "question": "جنگ اجتناب‌ناپذیر است.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود ندارد"
                },
                {
                    "id": 31,
                    "question": "اگر هم‌اکنون وارد جنگ شویم امکان پیروزی بیشتر از زمانی است که مجبور به جنگیدن شویم.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود دارد"
                },
                {
                    "id": 32,
                    "question": "اگر هم‌اکنون دست به یک جنگ پیشگیرانه نزنیم در هر جنگی که بعد از این به وسیله دشمن شروع بشود شکست خواهیم خورد.",
                    "choices": ["پیش فرض وجود دارد", "پیش فرض وجود ندارد"],
                    "answer": "پیش فرض وجود ندارد"
                }
            ]
        }
    ]
}
section3 = {
    "section_id": 3,
    "section_title": "نتیجه‌گیری منطقی",
    "instruction": """این بخش شامل ۵ موقعیت است که به دنبال هر یک چندین نتیجه پیشنهادشده است. برای رسیدن به اهداف این آزمون عبارات مطرح شده در هر موقعیت را بدون استثنا صحیح در نظر بگیرید. اولین نتیجه‌ای که در ذیل عبارت نوشته شده را بخوانید اگر فکر می‌کنید این نتیجه لزوماً از عبارت ارائه شده عاید می‌شود. یک علامت در برگه پاسخ‌نامه در ستون «نتیجه مطلب است» بگذارید و اگر فکر می‌کنید این نتیجه عبارت داده شده نیست، یک علامت در برگه پاسخ‌نامه در ستون «نتیجه مطلب نیست» بگذارید. 
به همین منوال هر یک از نتایج را بخوانید و قضاوت کنید که آیا هر نتیجه لزوماً از آن‌ها عاید می‌شود یا خیر. 
به مثال زیر توجه کنید: 
برخی روزهای تعطیل بارانی هستند. تمام روزهای بارانی کسل کننده‌اند؛ بنابراین: 
نتیجه می‌گیریم همه روزهای تعطیل، کسل کننده نمی‌باشد؛ یعنی این جمله نمی‌تواند نتیجه عبارت فوق شما ممکن است بدانید که برخی روزهای تعطیل بسیار لذت‌بخش هستند.""",
    "scenarios": [
        {
            "scenario_id": 1,
            "scenario": "موقعیت (الف)\nهرکس تفکر عملی داشته باشد، هیچ اعتقادی به پیشگویی‌های طالع‌بین‌ها نخواهد داشت؛ اما با این‌ وجود افراد زیادی هستند که معتقد بر فال‌نامه‌هایی هستند که طالع‌بین‌ها تهیه می‌کنند.",
            "questions": [
             {    
                "id": 33,
                "question": "افرادی که به فال‌نامه اعتقاد ندارند عملی فکر می‌کنند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب نیست"
                },
                {
                "id": 34,
                "question": "بسیاری از مردم، عملی فکر نمی‌کنند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب است"
                },
                {
                "id": 35,
                "question": "برخی از افرادی که عملی فکر می‌کنند به برخی از طالع بینی‌ها اعتماد دارند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب نیست"
                }
            ]
            },
            {
            "scenario_id": 2,
            "scenario": "موقعیت (ب)\nتمام نوازنده‌ها از نواختن موسیقی سنتی لذت می‌برند. تمام نوازنده‌ها ساعات طولانی به تمرین موسیقی سنتی می‌گذارند؛ بنابراین:",
            "questions": [
                {
                "id": 36,
                "question": "نوازنده‌هایی که موسیقی سنتی می‌نوازند از تمرین‌های طولانی‌مدت خسته و کسل نمی‌شوند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب نیست"
                },
                {
                "id": 37,
                "question": "برخی از نوازنده‌هایی که ساعات طولانی را به تمرین می‌گذارنند از نواختن موسیقی سنتی لذت می‌برند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب است"
                }
            ]
            },
            {
            "scenario_id": 3,
            "scenario": "موقعیت (ج)\nبرنج و کرفس برای رشد خوب نیاز به رطوبت کافی دارند؛ اما چاودار و پنبه در جاهایی که نسبتاً خشک هستند بهتر رشد می‌کند. برنج و پنبه در محل‌های سرد می‌رویند. در رشت هوا خیلی گرم و مرطوب است؛ بنابراین:",
            "questions": [
                {
                "id": 38,
                "question": "درجه حرارت و میزان رطوبت رشت هیچ‌کدام برای رشد کرفس مناسب نیستند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب نیست"
                },
                {
                "id": 39,
                "question": "دما و رطوبت رشت برای رشد برنج مناسب‌تر از کرفس، پنبه یا چاودار است.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب است"
                },
                {
                "id": 40,
                "question": "شرایط رشت در مجموع برای رشد محصول کرفس یا چاودار مساعد نیست.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب است"
                }
            ]
            },
            {
            "scenario_id": 4,
            "scenario": "موقعیت (د)\nبیشتر افرادی که تلاش می‌کنند تا عادت سیگار کشیدن را ترک کنند درمی‌یابند که سیگار چیزی است که یا به‌سختی می‌توانند آن را ترک کنند یا به‌هیچ‌وجه قادر به ترک آن نیستند، اما تمایل شدید به ترک سیگار تعداد کثیری از افراد را قادر ساخته است که این عادت را برای همیشه کنار بگذارند بنابراین:",
            "questions": [
                {
                "id": 41,
                "question": "فقط سیگاری‌هایی که میل شدید به ترک سیگار داشته باشند در انجام کار موفق خواهند شد.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب نیست"
                },
                {
                "id": 42,
                "question": "تمایل شدید به ترک سیگار، به برخی افراد کمک می‌کند که عادت خود را برای همیشه ترک کنند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب است"
                }
            ]
            },
            {
            "scenario_id": 5,
            "scenario": "موقعیت (هـ)\nدر یک شهر ۵۲ کلاس در ۵ مدرسه ابتدایی وجود دارد، هر کلاس ۱۰ تا ۴۰ دانش‌آموز دارد؛ بنابراین:",
            "questions": [
                {
                "id": 43,
                "question": "حداقل ۲ کلاس در شهر وجود دارد که دقیقاً تعداد دانش آموزان مساوی (یکسان) دارند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب است"
                },
                {
                "id": 44,
                "question": "بیشتر کلاس‌های دبستان‌های ابتدایی در شهر بیش از ۱۵ دانش‌آموز دارد.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب نیست"
                },
                {
                "id": 45,
                "question": "حداقل ۵۵۰ دانش‌آموز در این مدارس ابتدایی وجود دارند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب است"
                }
            ]
            },
            {
            "scenario_id": 6,
            "scenario": "موقعیت (و)\nبرخی از ابرقدرت‌ها دوست دارند که دنیا را کنترل کنند. مردم آن کشورها، در جستجوی یک زندگی بهتر برای خود می‌باشند؛ بنابراین:",
            "questions": [
                {
                "id": 46,
                "question": "برخی از مردم دوست دارند دنیا را تحت کنترل خود درآورند در جستجوی زندگی بهتری برای خود هستند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب است"
                },
                {
                "id": 47,
                "question": "برخی از مردمی که در جستجوی زندگی بهتری برای خود می‌باشند، دوست دارند دنیا تحت کنترل خود در آورند.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب است"
                },
                {
                "id": 48,
                "question": "اگر ابرقدرتی دنیا را تحت کنترل خود درآورند. می‌توانند مطمئن باشند که زندگی بهتری خواهد داشت.",
                "choices": ["نتیجه مطلب است", "نتیجه مطلب نیست"],
                "answer": "نتیجه مطلب نیست"
                }
            ]
        }
    ]
}
section4 = { 
    "section_id": 4, 
    "section_title": "تفسیر منطقی", 
    "instruction": """این بخش شامل ۵ شرح‌حال است... (همان متن قبلی باقی بماند)""", 
    "scenarios": [ 
        { 
            "scenario_id": 1, 
            "scenario": "تاریخ در هزار سال اخیر نشان می‌دهد که جنگ‌ها مرتباً بیشتر و همچنین مخرب‌تر شده‌اند . قرن بیستم بالاترین میزان را به هر لحاظ دارا بوده است.", 
            "questions": [ 
                {
                    "id": 49, 
                    "question": "توانایی بشر در حفظ صلح پیشرفت چندانی نکرده است.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج می‌شود"
                }, 
                {
                    "id": 50, 
                    "question": "اگر روال گذشته ادامه یابد، در قرن ۲۱ باید انتظار جنگ‌های بیشتری را نسبت به قرن ۲۰ داشته باشیم.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج می‌شود"
                }, 
                {
                    "id": 51, 
                    "question": "تعداد جنگ‌ها بیشتر و ماهیت آن‌ها نیز مخرب‌تر شده زیرا منابع طبیعی جهان ارزشمندتر شده‌اند.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج نمی‌شود"
                } 
            ] 
        },
        { 
            "scenario_id": 2, 
            "scenario": "هنگامی‌که کارخانه سیمان سپاهان اصفهان تأسیس گردید... (ادامه جمله‌ها)", 
            "questions": [ 
                {
                    "id": 52, 
                    "question": "به هنگام تأسیس، میزان تولید کارخانه سیمان سپاهان اصفهان کمتر از ۶۶ درصد کل تولید کشور نبود.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج می‌شود"
                }, 
                {
                    "id": 53, 
                    "question": "امروز میزان تولید رقبای داخلی کارخانه سیمان سپاهان اصفهان بیش از سه برابر تولیدات این کارخانه است.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج می‌شود"
                }, 
                {
                    "id": 54, 
                    "question": "امروز میزان تولیدات کارخانه سیمان سپاهان اصفهان کمتر از هنگام تأسیس آن می‌باشد.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج نمی‌شود"
                } 
            ] 
        },
        { 
            "scenario_id": 3, 
            "scenario": "مریم دارای وضعیت بدنی نامناسبی بود... (ادامه)", 
            "questions": [ 
                {
                    "id": 55, 
                    "question": "بدون درمان توسط دکتر پیام مریم بهتر نمی‌شد.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج نمی‌شود"
                }, 
                {
                    "id": 56, 
                    "question": "بعد از شروع درمان توسط دکتر پیام وضعیت زندگی مریم پیشرفت نمود.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج می‌شود"
                }, 
                {
                    "id": 57, 
                    "question": "مریم قبل از توصیه دوستش چیزی در مورد دکتر پیام نشنیده بود.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج نمی‌شود"
                } 
            ] 
        },
        { 
            "scenario_id": 4, 
            "scenario": "در یک منطقه آموزش‌وپرورش... (ادامه)", 
            "questions": [ 
                {
                    "id": 58, 
                    "question": "دانش‌آموزان روزنامه‌فروش بیش از سایر دانش‌آموزان مشتاق بودند که هیچ‌گونه گزارش غیبت در طول سال تحصیلی نداشته باشند.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج می‌شود"
                }, 
                {
                    "id": 59, 
                    "question": "به‌رغم اجرای دقیق قوانین حضور در مدرسه در این منطقه باز هم ۸۵ درصد دانش‌آموزان در طی سال تحصیلی غیبت داشتند.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج می‌شود"
                }, 
                {
                    "id": 60, 
                    "question": "اگر به بچه‌های گریزان از مدرسه، شغل روزنامه‌فروشی داده می‌شد حضور در مدرسه آن‌ها بهتر می‌شد.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج نمی‌شود"
                }, 
                {
                    "id": 61, 
                    "question": "در نظام این مدرسه تنها علت کمتر حاضر شدن دانش‌آموزان در مدرسه بیماری یا صدمه دیدن بود.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج نمی‌شود"
                } 
            ] 
        },
        { 
            "scenario_id": 5, 
            "scenario": "وقتی شب‌ها به بستر می‌روم... (ادامه)", 
            "questions": [ 
                {
                    "id": 62, 
                    "question": "مشکل من بیشتر یک مسئله روانی است. من انتظار دارم که قهوه مرا بیدار نگه دارد و بنابراین بیدار می‌مانم.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج نمی‌شود"
                }, 
                {
                    "id": 63, 
                    "question": "بعد از نوشیدن قهوه سریع به خواب نمی‌روم زیرا کافئین موجود در آن، سیستم عصبی مرا بیش‌ازحد تحریک می‌کند.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج نمی‌شود"
                }, 
                {
                    "id": 64, 
                    "question": "شب‌هایی که می‌خواهم سریع به خواب بروم بهتر است که عصرها قهوه ننوشم.", 
                    "choices": ["نتیجه استخراج می‌شود", "نتیجه استخراج نمی‌شود"],
                    "answer": "نتیجه استخراج می‌شود"
                } 
            ] 
        } 
    ] 
}
section5 = {
    "section_id": 5,
    "section_title": "تشخیص دلیل قوی یا ضعیف",
    "instruction": """برای تصمیم‌گیری در مورد سؤال‌های مهم...""",
    "scenarios": [
        {
            "scenario_id": 1,
            "scenario": "گزاره (الف)\nآیا وجود یک حزب کارگر قوی، رفاه عمومی را در کشور بهبود خواهد بخشید؟",
            "questions": [
                {
                    "id": 65,
                    "question": "خیر، یک حزب کارگر قوی، بخش خصوصی را نسبت به سرمایه‌گذاری در صنعت بی‌علاقه کرده و باعث به وجود آمدن بیکاری وسیع و مداوم می‌شود.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل قوی است"
                },
                {
                    "id": 66,
                    "question": "بله، امروزه وابستگان احزاب مختلف در بین خود اختلافاتی دارند.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل ضعیف است"
                },
                {
                    "id": 67,
                    "question": "خیر، احزاب کارگری تعدادی از صنایع مهم را به اعتصاب دعوت می‌کند.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل ضعیف است"
                }
            ]
        },
        {
            "scenario_id": 2,
            "scenario": "گزاره (ب)\nآیا می‌توان به آن دسته از گروه‌های سیاسی کشور که با برخی از مقررات دولتی مخالف‌اند اجازه آزادی نامحدود (بی‌قیدوشرط) در صحبت و فعالیت داد؟",
            "questions": [
                {
                    "id": 68,
                    "question": "بله، توسعه دموکراسی در کشور مبتنی بر مباحثات آزاد و محدود نشده انتقاد است.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل قوی است"
                },
                {
                    "id": 69,
                    "question": "خیر، چون کشورهایی که حکومتشان بر خلاف حکومت ما هست نیز اجازه بیان آزادانه نقطه‌نظرهای مردم را در محدوده خود نمی‌دهند.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل ضعیف است"
                },
                {
                    "id": 70,
                    "question": "خیر، اعطای آزادی کامل رسانه‌ای و بحث با گروه‌های مخالف، کشمکش هادی داخلی، تزلزل و بی‌ثباتی دولت و از دست رفتن دموکراسی خواهد شد.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل قوی است"
                }
            ]
        },
        {
            "scenario_id": 3,
            "scenario": "گزاره (ج)\nآیا وزارت دفاع کشور باید مردم را از برنامه‌های تحقیقی علمی خود و نیازهایی که به‌وسیله هر پروژه رفع می‌گردد مطلع سازد؟",
            "questions": [
                {
                    "id": 71,
                    "question": "خیر، زیرا درصورتی‌که پروژه‌هایی که به اطلاع رسیده است تا موفق باشد، برخی از مردم دولت را به یاد انتقاد خواهند گرفت.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل ضعیف است"
                },
                {
                    "id": 72,
                    "question": "بلی، فقط جامعه‌ای که بدین شکل مطلع شده باشد، با دادن مالیات بر درآمد از تحقیقات ضروری و فعالیت‌های توسعه‌ای پشتیبانی خواهد کرد.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل قوی است"
                },
                {
                    "id": 73,
                    "question": "خیر، لازم است که به دلیل حفظ امنیت ملی و دلایل بعضی پیشرفت‌های نظامی سری بماند.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل قوی است"
                }
            ]
        },
        {
            "scenario_id": 4,
            "scenario": "گزاره (د)\nآیا قضات دادگاه‌ها، زمانی که یکی از طرفین دعوی فقیر و دیگری ثروتمند باشد، منصفانه قضاوت می‌کنند؟",
            "questions": [
                {
                    "id": 74,
                    "question": "خیر، زیرا افراد ثروتمند بیشتر دعوی‌های خود را خارج از دادگاه فیصله می‌دهند.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل ضعیف است"
                },
                {
                    "id": 75,
                    "question": "خیر، بیشتر قضات دادگاه‌ها نسبت به مردم فقیر بیش از افراد ثروتمند دلسوزی نشان می‌دهند و این احساس روسای دادگاه‌ها و نحوه قضاوت آن‌ها تأثیر می‌گذارد.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل قوی است"
                },
                {
                    "id": 76,
                    "question": "خیر، زیرا افراد ثروتمند می‌توانند وکلای بهتری استخدام کنند و قضات دادگاه‌ها تحت تأثیر مهارت وکلای طرفین دعوی قرار می‌گیرند.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل قوی است"
                }
            ]
        },
        {
            "scenario_id": 5,
            "scenario": "گزاره (هـ)\nآیا می‌توان به دانش‌آموزان مدارس راهنمایی اجازه داد که طی ساعات کلاس به جلسات تمرینی تیم‌های ورزشی خود رفته و در آنجا خود را برای مسابقات آماده کنند.",
            "questions": [
                {
                    "id": 77,
                    "question": "خیر، رفتن دانش‌آموزان مدرسه راهنمایی به جلسات تمرینی طی ساعات درسی با فرآیند تعلیم و تربیت تداخل جدی ایجاد کرده باعث به وجود آمدن اختلاف بین دانش‌آموزان کلاس‌های مختلف می‌گردد.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل قوی است"
                },
                {
                    "id": 78,
                    "question": "بلی، آموزش و تمرین فعالیت‌های ورزشی به برطرف شدن مسائل و انحرافات اخلاقی و بی‌توجهی نسبت به سایرین که به نظر می‌رسد هر دو از مشکلات فعلی جامعه ما باشند، کمک می‌کند.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل ضعیف است"
                },
                {
                    "id": 79,
                    "question": "بلی، آموزش تمرینات بدنی، برای حفظ سلامت جسمانی خیلی اهمیت دارد.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل ضعیف است"
                },
                {
                    "id": 80,
                    "question": "خیر، آموزش ورزش طی ساعات درسی، سبب نقص برخی از قوانین رفت‌وآمد دانش‌آموزان به مدرسه خواهد شد. کسانی که علاقه‌مند به چنین آموزش‌هایی هستند. می‌توانند بعد از ساعت مدرسه به فراگیری آن‌ها بپردازند.",
                    "choices": ["دلیل قوی است", "دلیل ضعیف است"],
                    "answer": "دلیل قوی است"
                }
            ]
        }
    ]
}

all_sections = [section1, section2, section3, section4, section5]
scenario_map = []
for section_idx, section in enumerate(all_sections):
    for scenario_idx, scenario in enumerate(section["scenarios"]):
        scenario_map.append((section_idx, scenario_idx))
total_pages = len(scenario_map)

# استایل راست‌چین و کارت رنگی
st.markdown("""
<style>
html, body, [class*="css"], div, span, input, label, button, textarea, select, p, h1, h2, h3, h4, h5, h6, li, ul, ol, table, th, td {
    font-family: 'B Nazanin', Tahoma, Arial, sans-serif !important;
    direction: rtl !important;
}
.stButton>button, .stRadio, .stCheckbox, .stTextInput>div>input {
    font-family: 'B Nazanin', Tahoma, Arial, sans-serif !important;
}

/* کارت هدر بخش */
.section-header {
    background: linear-gradient(90deg, #FFE082 40%, #FFD54F 100%);
    border-radius: 18px;
    padding: 18px 32px 14px 20px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px #ffd70022;
    color: #784421;
    font-size: 1.28rem;
    font-weight: bold;
    border: 2px solid #ffecb3;
    line-height: 2.3;
    display: flex; align-items: center;
}
.section-header::before {
    content: '📚';
    font-size: 2.1rem;
    margin-left: 12px;
    margin-right: 8px;
}
/* سناریو کارت */
.scenario-card {
    background: linear-gradient(90deg, #B2DFDB 0%, #F8BBD0 100%);
    border-radius: 20px;
    padding: 18px 26px 16px 18px;
    margin-bottom: 32px;
    box-shadow: 0 2px 12px #f8bbd066;
    color: #1b2134;
    font-size: 1.11rem;
    border: 1.8px solid #80cbc4;
    text-align: right;
    line-height: 2.13;
    display: flex;
    align-items: flex-start;
    position: relative;
}
.scenario-card::before {
    content: '📝';
    font-size: 2rem;
    margin-left: 14px;
    margin-right: 5px;
    opacity: 0.7;
}
/* ... ادامه بقیه کلاس‌ها ... */
.question-card {
    background: linear-gradient(90deg, #FFFDE7 0%, #E1BEE7 100%);
    border-radius: 16px;
    padding: 14px 17px 8px 10px;
    margin-bottom: 17px;
    box-shadow: 0 2px 10px #e1bee777;
    color: #232323;
    font-size: 1.09rem;
    border: 1.2px solid #d1c4e9;
    text-align: right;
    transition: box-shadow 0.2s, border 0.2s;
    position: relative;
    display: flex; align-items: flex-start;
}
    .question-card:hover {
        box-shadow: 0 4px 18px #ab47bc45;
        border: 1.2px solid #ab47bc;
    }
    .question-badge {
        background: #c8e6c9;
        color: #388e3c;
        border-radius: 7px;
        font-weight: bold;
        font-size: 1.03rem;
        padding: 2px 10px;
        margin-left: 11px;
        border: 1.1px solid #388e3c55;
        vertical-align: middle;
        box-shadow: 0 1px 3px #388e3c22;
    }
    .question-card::before {
        content: '❓';
        font-size: 1.5rem;
        margin-left: 11px;
        margin-right: 2px;
        opacity: 0.8;
    }
    /* دکمه‌ها */
    button[kind="secondary"], .stButton>button {
        background: linear-gradient(90deg, #81d4fa 0%, #b388ff 100%) !important;
        color: #fff !important;
        border-radius: 16px !important;
        border: 1.3px solid #b388ff !important;
        font-size: 1.08rem !important;
        font-family: 'Vazir' !important;
        padding: 8px 36px !important;
        margin: 0 8px 12px 0 !important;
        box-shadow: 0 2px 10px #b388ff33;
        transition: box-shadow 0.18s;
    }
    button[kind="secondary"]:hover, .stButton>button:hover {
        box-shadow: 0 4px 16px #81d4fa55;
        background: linear-gradient(90deg, #b388ff 0%, #81d4fa 100%) !important;
    }
    .stRadio > div { direction: rtl; }
    /* پاسخ صحیح/غلط */
    .correct-answer {
        color: #388e3c;
        background: #e8f5e9;
        padding: 0px 10px;
        border-radius: 8px;
        font-weight: bold;
    }
    .incorrect-answer {
        color: #c62828;
        background: #ffebee;
        padding: 0px 10px;
        border-radius: 8px;
        font-weight: bold;
    }
    </style>
""", unsafe_allow_html=True)


if "global_page" not in st.session_state:
    st.session_state.global_page = 0

current_page = st.session_state.global_page
current_section_idx, current_scenario_idx = scenario_map[current_page]
current_section = all_sections[current_section_idx]
current_scenario = current_section["scenarios"][current_scenario_idx]

# ==== ۴. مدیریت پاسخ‌ها (برای هر بخش و هر سناریو جدا) ====
if "user_answers" not in st.session_state:
    st.session_state.user_answers = [
        [{} for _ in range(len(section["scenarios"]))] for section in all_sections
    ]
user_answers = st.session_state.user_answers[current_section_idx][current_scenario_idx]

# ==== ۵. نمایش عنوان و راهنما ====
if current_scenario_idx == 0:
    st.markdown(
        f'<div class="section-header">{current_section["section_title"]}</div>',
        unsafe_allow_html=True
    )
    if current_scenario_idx == 0:
        st.markdown(current_section['instruction'])

else:
    st.markdown(f'<div class="section-header">{current_section["section_title"]}</div>', unsafe_allow_html=True)

# ==== ۶. نمایش سناریو ====
st.markdown(
    f'<div class="scenario-card">'
    f'<span class="scenario-badge">سناریو {current_scenario_idx + 1}</span> '
    f'{current_scenario["scenario"]}'
    f'</div>',
    unsafe_allow_html=True
)

# ==== ۷. نمایش سوالات و گزینه‌ها ====
def get_global_question_number():
    total = 0
    for sidx, section in enumerate(all_sections):
        for scidx, scenario in enumerate(section["scenarios"]):
            if sidx < current_section_idx or (sidx == current_section_idx and scidx < current_scenario_idx):
                total += len(scenario["questions"])
    return total

for local_idx, q in enumerate(current_scenario["questions"]):
    global_q_num = get_global_question_number() + local_idx + 1
    st.markdown(
        f'<div class="question-card">'
        f'<span class="question-badge">سوال {global_q_num}</span> '
        f'{q["question"]}'
        f'</div>',
        unsafe_allow_html=True
    )

    prev_value = user_answers.get(q['id'], None)
    user_ans = st.radio(
        label="",
        options=q["choices"],
        key=f"q_{current_section_idx}_{current_scenario_idx}_{q['id']}",
        index=q["choices"].index(prev_value) if prev_value in q["choices"] else 0,
        horizontal=True
    )
    user_answers[q['id']] = user_ans

st.session_state.user_answers[current_section_idx][current_scenario_idx] = user_answers

col1, col2, col3 = st.columns([1,2,1])
with col2:
    if current_page > 0:
        if st.button("صفحه قبل"):
            st.session_state.global_page -= 1
            st.experimental_rerun()
    if current_page < total_pages - 1:
        if st.button("صفحه بعد"):
            st.session_state.global_page += 1
            st.experimental_rerun()

# ==== ۹. دکمه ثبت و نمایش نتیجه (در آخرین سناریوی هر بخش) ====
if current_page == total_pages - 1:
    if st.button("مشاهده نتیجه نهایی"):
        total_score = 0
        total_questions = 0
        st.write("---")
        st.markdown("## نتیجه نهایی شما:")

        # --- 1. محاسبه امتیاز هر بخش و ذخیره نتایج ---
        section_scores = []
        section_question_counts = []

        # اطلاعات برای تحلیل هوش مصنوعی
        section_analysis_input = []

        q_global_idx = 1
        for section_idx, section in enumerate(all_sections):
            section_score = 0
            section_questions = 0
            answers = []
            st.markdown(f"### {section['section_title']}")
            for scenario_idx, scenario in enumerate(section["scenarios"]):
                st.markdown(f"**سناریو {scenario_idx+1}:** {scenario['scenario']}")
                for q in scenario["questions"]:
                    user_ans = st.session_state.user_answers[section_idx][scenario_idx].get(q["id"], "")
                    correct_ans = q.get("answer", "")
                    if "answer" in q:
                        if user_ans == correct_ans:
                            st.markdown(f'<span class="correct-answer">✔ صحیح</span>', unsafe_allow_html=True)
                        else:
                            st.markdown(f'<span class="incorrect-answer">✘ نادرست</span>', unsafe_allow_html=True)
                        is_correct = (user_ans == correct_ans)
                        section_score += int(is_correct)
                        section_questions += 1
                        total_score += int(is_correct)
                        total_questions += 1
                    else:
                        is_correct = None
                    st.markdown(
                        f"- **سؤال {q_global_idx}:** {q['question']}  \n"
                        f"  ⟶ پاسخ شما: **{user_ans}**"
                        + (f" | پاسخ صحیح: **{correct_ans}**" if "answer" in q else "")
                    )
                    q_global_idx += 1

                    # برای تحلیل AI:
                    answers.append({
                        "question": q["question"],
                        "user_answer": user_ans,
                        "correct_answer": correct_ans
                    })
            # ذخیره امتیاز و تعداد سوال هر بخش
            section_scores.append(section_score)
            section_question_counts.append(section_questions)

            # آماده‌سازی داده برای مدل زبانی
            section_analysis_input.append({
                "section_title": section["section_title"],
                "score": section_score,
                "total": section_questions,
                "answers": answers
            })

            st.info(f"✅ امتیاز شما در این بخش: {section_score} از {section_questions}")

        st.success(f"امتیاز کل شما: {total_score} از {total_questions}")

        # --- 2. جدول خلاصه امتیازات بخش‌ها ---
        st.write("---")
        st.markdown("### خلاصه امتیاز بخش‌ها:")
        for i, section in enumerate(all_sections):
            st.write(f"**{section['section_title']}**: {section_scores[i]} / {section_question_counts[i]}")

        # --- 3. ساخت پرامپت برای مدل زبانی Gemini ---
        gemini_prompt = """
شما یک منتقد سخت‌گیر آزمون تفکر انتقادی هستید. تمام پاسخ‌های کاربر را با دقت و وسواس بالا بررسی کن و هرگونه ضعف، اشتباه، ابهام یا عدم دقت را صریح و بدون ملاحظه برجسته کن. حتی اگر پاسخ‌ها به ظاهر صحیح باشند، هر مورد تردید، محافظه‌کاری، برداشت اشتباه، یا پاسخ سطحی را به‌شدت نقد کن. در هر بخش، علاوه بر تحلیل کلی، برای هر نقطه ضعف یا اشتباه جزئی نیز توضیح بده و نمونه بیاور. توصیه‌هایت نیز باید صریح، مستقیم و به‌دور از تعارف باشد.
فرمت خروجی مشابه نمونه زیر باشد:

❌ ضعف در جسارت تحلیلی: نمی‌تونه در موقعیت‌های نیازمند قضاوت قاطع، تصمیم بگیره.

❌ تمایز ضعیف بین توصیف و دلیل: متن‌هایی که بار توصیفی دارند را گاهی به عنوان دلیل ارزیابی می‌کنه.

❌ تفسیر احساسی در متون اجتماعی: مخصوصاً در حوزه‌هایی مثل آموزش، بهداشت، جنگ یا عدالت.

❌ ضعف در درک تلویحات منطقی سطح عمیق: پیش‌فرض‌های پنهان‌تر یا ساختارهای چندلایه گاهی نادیده گرفته می‌شن.

❌ پذیرش استدلال‌های شعاری یا سطحی به عنوان دلیل قوی.

بخش ۱: استنباط 
🎯 نمره تقریبی: 12 از 16
📉 تحلیل: فرد در اکثر موارد، به جای انتخاب قطعی (درست/غلط)، گزینه‌های «احتمالاً درست» یا «داده‌ها کافی نیست» را انتخاب کرده است. این نشان از احتیاط بالا دارد، اما فقدان قاطعیت نمره را کاهش می‌دهد.
⚠️ نقطه ضعف: عدم جسارت تحلیلی در گزاره‌های قابل استنتاج.
🔍 بخش ۲: پیش‌فرض‌ها
🎯 نمره تقریبی: ۸.۵ از 16
📈 تحلیل:
فرد توانسته است به خوبی وجود یا عدم وجود پیش‌فرض را شناسایی کند.

تفکیک بین چیزی که صراحتاً گفته شده و چیزی که مخفیانه فرض شده، در بیشتر موارد دقیق است.

⚠️ نقطه ضعف:
در برخی موارد، پیش‌فرض‌های ضمنی کاملاً مشهود هستند، اما شرکت‌کننده هنوز در مرز ابهام باقی می‌ماند (مثل خطرات انرژی اتمی یا مدیریت شهری).

تفکیک پیش‌فرض از پیامد یا داده‌ی توصیفی گاهی اشتباه گرفته شده.

🔍 بخش ۳: نتیجه‌گیری منطقی
🎯 نمره تقریبی:8 از 16
📈 تحلیل:
پاسخ‌ها دقیق و مبتنی بر منطق استنتاجی‌اند.

تمایز بین نتیجه‌گیری از پیش‌فرض و «ادعای مستقل» به خوبی درک شده.

⚠️ نقطه ضعف:
صرفاً یک یا دو مورد، گزاره‌هایی مثل تأثیر خواب یا اثر دکتر پیام، دچار ساده‌سازی بیش‌ازحد شده‌اند.

در یک مورد، تأثیر تکرار یا تمرین در موفقیت به جای استنتاج، به صورت ضمنی تأیید شده است، که نباید باشد.

🔍 بخش ۴: تعبیر و تفسیر از شرح حال
🎯 نمره تقریبی: 7 از 16
📉 تحلیل:
فرد توانسته از روایت‌های نسبتاً پیچیده (مانند گزارش غیبت، تغییرات اجتماعی، یا کارخانه سیمان) برداشت‌های منطقی قابل استناد داشته باشد.

اما در چند مورد، به‌خصوص در روایت‌های احساسی یا توصیفی، برداشت‌های احساسی‌تر یا عمومی‌تر به‌جای استنتاج دقیق آمده‌اند.

⚠️ نقطه ضعف:
ضعف در تمایز بین برداشت شخصی و نتیجه‌گیری مبتنی بر شواهد عینی.

مواردی مثل تأثیر پیام یا بهبود وضعیت پس از درمان، به صورت مستقیم قابل اثبات نبود ولی فرد برداشت را به عنوان نتیجه گرفته.

🔍 بخش ۵: ارزیابی دلایل
🎯 نمره تقریبی: 7 از 16
📉 تحلیل:
در بسیاری موارد دلایل «ضعیف» به درستی شناسایی شده‌اند، اما چند مورد دلیل ضعیف به اشتباه «قوی» فرض شده‌اند.

برای مثال، گزاره‌هایی درباره‌ی احزاب کارگری، تمرین بدنی، تأثیر تربیت بدنی بر رفتار دانش‌آموزان بدون شواهد کافی «دلیل قوی» تلقی شده‌اند، در حالی که بیشتر پیشنهاد هستند تا استدلال قطعی.

⚠️ نقطه ضعف:
ضعف در تشخیص تفاوت بین رابطه علی و همبستگی سطحی.

برخی دلایل صرفاً شعاری یا فرضی بوده‌اند، اما شرکت‌کننده آن‌ها را معتبر تلقی کرده.



🛠️ نقاط ضعف کلیدی (متمرکز برای بهبود در مصاحبه و کار)
کمبود جسارت تحلیلی در بخش‌های نیازمند استنباط قاطع.

تمایل به تفسیر شخصی در شرایط احساسی یا انسانی (بخش درمان، غیبت، دکتر پیام).

عدم تمایز دقیق میان علت و همبستگی در ارزیابی دلایل.

پذیرش استدلال‌های شعاری به عنوان دلایل قوی.

📢 توصیه (بدون تعارف):  
برای پیشرفت در آزمون‌های سطح بالا، باید قاطعیت، شجاعت تحلیلی و پذیرش ریسک منطقی در پاسخ‌دهی را تقویت کند؛ در غیر این‌صورت پیشرفتی حاصل نمی‌شود.


"""
        for section in section_analysis_input:
            gemini_prompt += f"\n\nبخش: {section['section_title']}\n"
            gemini_prompt += f"🎯 نمره تقریبی: {section['score']} از {section['total']}\n"
            gemini_prompt += "پاسخ‌ها:\n"
            for ans in section["answers"]:
                gemini_prompt += f"- سؤال: {ans['question']}\n  ⟶ پاسخ کاربر: {ans['user_answer']} | پاسخ صحیح: {ans['correct_answer']}\n"

        # --- 4. فراخوانی مدل Gemini و دریافت تحلیل ---
        import google.generativeai as genai
        from google.generativeai import types as genai_types

        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel("models/gemini-1.5-flash")
        try:
            response = model.generate_content(
                gemini_prompt,
                generation_config=genai_types.GenerationConfig(
                    temperature=0.33, max_output_tokens=1100
                )
            )
            ai_analysis = response.text
        except Exception as e:
            ai_analysis = f"خطا در دریافت تحلیل از مدل Gemini: {e}"

        # --- 5. نمایش تحلیل هوشمند در صفحه ---
        st.write("---")
        st.markdown("### تحلیل هوشمند آزمون (بر اساس پاسخ‌های شما):")
        st.info(ai_analysis)
